# Rewrite Rules
1. WordPress allows theme and plugin developers to programmatically specify new, custom rewrite rules.
2. Note that these rules are usually called inside the init hook. Furthermore, permalinks will need to be refreshed before the rewrite changes will take effect. Requires one-time use of `flush_rules()` to take effect.

## Functions
### [`add_rewrite_tag()`]()
1. Adds a new rewrite tag (like %postname%).
2. Parameters
    - `$tag` name of new rewrite tag.
    - `$regex` Regular expression to substitute the tag for in rewrite rules.
    - `$query` String to append to the rewritten query. Must end in `=` 

**Example**

In the following examples, imagine a site has a custom taxonomy ‘location’ and all posts are assigned a location term like “Paris” or “Madrid”. We add a rewrite tag “%location%” to establish the location query var. We also add a rewrite rule so that an URL such as example.com/goto/madrid/budget-lodging/ is properly handled.

```php
add_action('init', 'add_my_rewrites');
function add_my_rewrites() {
    add_rewrite_tag('%location%', '([^&]+)');
    add_rewrite_rule('^goto/([^/]*)/([^/]*)/?','index.php?location=$matches[1]&name=$matches[2]','top');
}
```

In order to retrive the tag, just use

```php
$wp_query->query_vars['location']
```

### [`add_rewrite_rule()`]()
1. Adds a rewrite rule that transforms a URL structure to a set of query vars.

```php
add_rewrite_rule(
    string $regex, // Regex to match
    string | array $query, // Conversion to query
    string $after = 'bottom' // Where to place ? `top` or `bottom` ?
)
```

```php
<?php
function custom_rewrite_rule() {
    add_rewrite_rule('^nutrition/([^/]*)/([^/]*)/?','index.php?page_id=12&food=$matches[1]&variety=$matches[2]','top');
}
add_action('init', 'custom_rewrite_rule', 10, 0);
```


In the following examples, imagine a site has a custom taxonomy ‘location’ and all posts are assigned a location term like “Paris” or “Madrid”. We add a rewrite tag “%location%” to establish the `location` query var. We also add a rewrite rule so that an URL such as _example.com/goto/madrid/budget-lodging/_ is properly handled.

[Copy](https://developer.wordpress.org/reference/functions/add_rewrite_tag/#)

```php
add_action('init', 'add_my_rewrites');
function add_my_rewrites() {
    add_rewrite_tag('%location%', '([^&]+)', 'location=');
    add_rewrite_rule('^goto/([^/]*)/([^/]*)/?','index.php?location=$matches[1]&name=$matches[2]','top');
}
```

Even though rewrite tags look just like permalink structure tags, if you try to use your rewrite tag in a permalink structure, the URLs generated by WordPress will look something like _example.com/goto/%location%/budget-lodging/_. The proper term does not replace the rewrite tag as you might expect. To make your tag behave like a structure tag, use the “post_link” filter to replace the tag with the proper term.

[Expand code](https://developer.wordpress.org/reference/functions/add_rewrite_tag/#)

[Copy](https://developer.wordpress.org/reference/functions/add_rewrite_tag/#)

```php
// Assign value to %location% rewrite tag
add_filter('post_link', 'my_filter_post_link', 10, 2 );
function my_filter_post_link( $permalink, $post ) {

    // bail if %location% tag is not present in the url:
    if ( false === strpos( $permalink, '%location%' ) ) {
        return $permalink;
    }
    $terms = wp_get_post_terms( $post->ID, 'location' );
    // set location, if no location is found, provide a default value.
    if ( 0 < count( $terms ) ) {
        $location = $terms[0]->slug;
    } else {
        $location = 'timbuktu';
        $location = urlencode( $location );
        $permalink = str_replace('%location%', $location , $permalink );
    }
    return $permalink;
}
```

Anytime you change something related to the Rewrite API, don’t forget to flush the rewrite rules! This can be done without code by going to Permalink Settings and clicking Save Changes. You don’t actually need to make any changes on the settings screen.